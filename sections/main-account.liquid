{{ 'customer.css' | asset_url | stylesheet_tag }}
{{ 'main-account.css' | asset_url | stylesheet_tag }}

<div class="section-spacing" id="account-shopify">
  <div class="row">
    <div class="small-12 columns">
      <div class="myaccount--header">
        <h1 class="myaccount--title">{{ 'customer.account.title' | t }}</h1>
        <p>
          <a
            href="{{ routes.account_logout_url }}"
            title="{{ 'customer.account.log_out' | t | escape }}"
            class="myaccount--link"
          >
            {% render 'svg-icons' with 'thb-log-out' %}
            <span class="text-button">{{ 'customer.account.log_out' | t }}</span>
          </a>
        </p>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="small-12 large-8 columns myaccount-content">
      <div id="data-container"></div>
      <div id="loader">Loading...</div>

      <div id="pagination-container">
        <button id="loadMoreButton" class="order-btn" onclick="loadMoreData()" disabled>Load More</button>
      </div>

      {% comment %}
        <h4 style="font-weight:500">{{ 'customer.orders.title' | t }}</h4>
        {% paginate customer.orders by 6 %}
          {%- if customer.orders.size > 0 -%}
            {% for order in customer.orders %}
              {% comment %} <a> {% endcomment %}

              <div
                style="
                  border: 1px solid #0000001a;
                  padding: 1rem;
                  margin-bottom: 1rem;
                "
              >
                <a href="{{ order.customer_url }}">
                  <div
                    style="
                                         display:flex; justify-content:space-between;
                      margin-bottom: 1rem;
                      border-bottom: 1px solid #e8e8e8;
                      padding-bottom: 0.5rem;font-weight: 600;
                      font-size: 14px;
                    "
                  >
                    <div>
                      <div style="display:flex; justify-content:space-between">
                        <div
                          style="display:flex;"
                        >
                          <div style="margin-right:0.5rem">Order ID:</div>
                          <div>{{ order.name }}</div>
                        </div>
                      </div>
                      {%- assign order_date = order.created_at | time_tag: format: 'date_at_time' -%}
                      <div
                        style="
                          font-weight: 400;
                          font-size: 0.8rem;
                        "
                      >
                        {{ 'customer.order.date_html' | t: date: order_date }}
                      </div>
                    </div>
                    <div>
                      {% if order.cancelled %}
                        <div style="color:red;text-align:right">
                          <div>CANCELLED</div>
                          <div style="font-weight:400;font-size: 0.8rem;">({{ order.cancel_reason_label }})</div>
                        </div>
                      {% else %}
                        <div style="text-transform:uppercase;text-align:right">{{ order.fulfillment_status_label }}</div>
                        <div style="color: #888383;font-size: 0.8rem;font-weight:400;text-align:right">
                          {% if order.financial_status_label == 'Pending' -%}
                            Payment Pending
                          {% else %}
                            {{ order.financial_status_label }}
                          {% endif %}
                        </div>
                      {% endif %}
                    </div>
                  </div>

                  {% for item in order.line_items %}
                    {% assign title_words = item.title | split: '|' %}

                    <div style="display:flex;margin-bottom:1rem">
                      <div class="account_image">
                        <img style="width:100%" src="{{item.product.featured_image | image_url}}">
                      </div>
                      <div style="display: flex;align-items: center;margin-left: 1rem;width:70%">
                        <div>
                          <div
                            style="
                              font-size: 12px;
                              font-style: normal;
                              font-weight: 700;
                            "
                          >
                            {{ title_words[0] }}
                          </div>
                          <div
                            style="
                              font-size: 12px;
                              font-style: normal;
                              font-weight: 400;
                            "
                          >
                            {{ title_words[1] }}
                          </div>
                          <div
                            style="
                              color:#626262;
                              font-size: 10px;
                              font-style: normal;
                              font-weight: 300;
                            "
                          >
                            <span>Size: {{ item.variant.title }}</span> | <span>Qty:{{ item.quantity }}</span>
                          </div>
                          <div style="font-size:12px">{{ item.price | money_with_currency }}</div>
                        </div>
                      </div>
                      {% comment %}
                        <p class="product-tittle-reamaining_words">
                          {% for i in (1..title_words.size) %}
                            {{ title_words[i] }}
                          {% endfor %}
                        </p>
                      {% endcomment %}
                    </div>
                  {% endfor %}

                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      border-top: 1px solid #e8e8e8;
                      padding-top: 0.5rem;
                      margin-top: 1.5rem;font-size: 14px;
                    "
                  >
                    <div
                      style="margin-right:0.5rem;"
                    >
                      Subtotal Price :
                    </div>
                    <div>{{ order.line_items_subtotal_price | money_with_currency }}</div>
                  </div>
                  <div style="display: flex;justify-content: space-between;font-size: 14px;">
                    <div
                      style="margin-right:0.5rem;"
                    >
                      Discount:
                    </div>
                    <div>
                      {% for disc in order.discount_applications %}
                        <div>
                          <span>- {{ disc.total_allocated_amount | money_with_currency }}</span>
                          <span>({{ disc.title }})</span>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                  <div
                    style="
                        display: flex;justify-content: space-between;
                        padding-top: 0.5rem;
                      font-size: 16px;
                    "
                  >
                    <div
                      style="margin-right:0.5rem;"
                    >
                      Total Price :
                    </div>
                    <div>{{ order.total_price | money_with_currency }}</div>
                  </div>
                </a>
                <div style="display:flex;align-items:center;justify-content:space-between">
                  {% if order.fulfillment_status == 'fulfilled' %}
                    <button
                      style="
                        white-space: normal;
                        margin-top: 1rem !important;
                      "
                      class="
                        js-return-exchange {% if order.tags contains 'Non_Returnable' or order.tags contains 'Non_Exchangeable' %}disabled hide-strict{% endif %}
                        {% if order.fulfillment_status != 'fulfilled' %} disabled hide-strict{% endif %}
                      "
                      data-order="{{ order.name }}"
                      data-customer="{{ customer.email }}"
                    >
                      Return / Exchange
                    </button>
                  {% endif %}
                </div>
              </div>
            {% endfor %}

          {%- else -%}
            <p>{{ 'customer.orders.none' | t }}</p>
          {%- endif -%}
          {% render 'pagination', paginate: paginate, pagination_type: 'paginated' %}
        {% endpaginate %}
      {% endcomment %}
    </div>
    <div class="small-12 large-4 columns myaccount-sidebar">
      <h4>{{ 'customer.account.details' | t }}</h4>
      {% if customer.default_address %}
        <label>{{ 'customer.account.default_address' | t }}</label>
        <address>
          {{ customer.default_address.address1 -}}
          <br>
          {% if customer.default_address.address2 != '' %}
            {{ customer.default_address.address2 -}}
            <br>
          {% endif %}
          {{ customer.default_address.city }},
          {% if address.default_address.province_code %}{{ customer.default_address.province_code }}, {% endif -%}
          {{- customer.default_address.country -}}
          <br>
          {{ customer.default_address.zip -}}
          <br>
          {{ customer.default_address.phone }}
        </address>
      {% endif %}
      <a href="{{ routes.account_addresses_url }}" class="text-button">
        {{ 'customer.account.view_addresses' | t }} ({{ customer.addresses_count }})
      </a>
    </div>
  </div>

  <modal-dialog id="PopupModal-cancelReasons" class="product-popup-modal">
    <div
      role="dialog"
      aria-label="Cancel Reasons"
      aria-modal="true"
      class="product-popup-modal__content cancellation_reasons_modal"
      tabindex="-1"
    >
      <div
        style="
          margin-top: 1rem;
          margin-left: 1rem;
        "
      >
        Select Cancellation Reason
      </div>
      <button
        id="ModalClose-{{ section.id }}"
        type="button"
        class="modal_close"
        aria-label="{{ 'accessibility.close' | t }}"
      >
        {% render 'svg-icons' with 'close' %}
      </button>
      <div id="cancellation_div"></div>
      <button class="cancel_button" onclick="cancelOrderCall()">Cancel</button>
    </div>
  </modal-dialog>
</div>
{% assign orderStatus = customer.orders | json %}
<script>

  
  function redirectToOrderDetails (orderName,lineItemId)  {
   const selectedIndex = ordersGroup[orderName].map(order => order.lineItemId).findIndex(oId=>oId==lineItemId);
   const storageData = {
    selectedIndex, data:ordersGroup[orderName]
    }
    sessionStorage.setItem("selectedOrder", JSON.stringify(storageData))
    }

  function callApiAndOpenModal(event) {
    event.preventDefault();
    fetch('http://localhost:3004/cancellationReasons')
      .then((response) => response.json())
      .then((data) => {
        console.log(data);
        renderCancellationUI(data);
      })
      .catch((error) => {
        console.error('Error fetching data:', error);
      });
    return false;
  }

  function renderCancellationUI(data) {
    const renderDiv = document.getElementById('cancellation_div');
    // Number of times to append the HTML
    var numberOfTimes = 5;

    // Loop to append HTML content to the div
    renderDiv.innerHTML = '';
    for (var i = 0; i < numberOfTimes; i++) {
      var isChecked = i === 0 ? 'checked' : '';
      renderDiv.innerHTML += `<p><input type="radio" id="${i}_cancel" name="drone" value="huey" ${isChecked}  /><label for="${i}_cancel">${data[i].body}</label></p>`;
    }
  }
  var orderStatus = '{{ orderStatus }}';

  function cancelOrderCall() {
    fetch('http://localhost:3004/cancellationReasons')
      .then((response) => response.json())
      .then((data) => {
        {% comment %} document.querySelector('#ModalClose-{{ section.id }}').click(); {% endcomment %}
        window.location.reload();
      })
      .catch((error) => {
        console.error('Error fetching data:', error);
      });
  }




    const apiUrl = 'https://api.damocles.co.in/shop/customer/v1/orders/6293839773798'; // Replace with your actual API URL
    let endCursor = '';
    let pageCount = 1; // Keep track of the current page count


    let ordersGroup = {}


    async function fetchData() {



      try {
        {% comment %} const response = await fetch(apiUrl, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'after': endCursor // Send endCursor as 'after' in headers
          }
        }); {% endcomment %}


        const data = await new Promise(res=>res({
    "orders": [
        {
            "orderName": "#1113",
            "orderId": "gid://shopify/Order/5297336057958",
            "fullfillmentName": null,
            "displayStatus": "unfulfilled",
            "shippingAddress": {
                "address1": "Virgio (Ameyam Enterprise Private Limited) 168 19th Main Road Sector 4 HSR Layout",
                "address2": null,
                "city": "Bengaluru",
                "name": "Omesh Koul",
                "phone": null,
                "zip": "560102",
                "country": "India"
            },
            "quantity": 1,
            "discountedTotal": "10.00",
            "originalTotal": "10.00",
            "skuId": "VWWDR233601700122",
            "variantTitle": "S / Green",
            "title": "Aiza|Breezy cotton geo-print fit and flare dress",
            "image": "https://cdn.shopify.com/s/files/1/0558/4909/1174/files/1_VWWDR2336017001.jpg?v=1701959093",
            "totalReceived": "3784.00",
            "lineItemId": "gid://shopify/LineItem/13712383770726",
            "productHandle": "geo-printed-fit-and-flare-dress",
            "discountAllocation": "1.2",
            "order": {
                "totalPrice": "3784.00",
                "subtotalPrice": "3784.00",
                "totalShippingPrice": "0.00",
                "totalDiscounts": "516.00",
                "createdAt": "2024-01-17T11:38:59Z"
            },
            "isCancellable": true,
            "isReturnable": false
        },
        {
            "orderName": "#1113",
            "orderId": "gid://shopify/Order/5297336057958",
            "fullfillmentName": null,
            "displayStatus": "unfulfilled",
            "shippingAddress": {
                "address1": "Virgio (Ameyam Enterprise Private Limited) 168 19th Main Road Sector 4 HSR Layout",
                "address2": null,
                "city": "Bengaluru",
                "name": "Omesh Koul",
                "phone": null,
                "zip": "560102",
                "country": "India"
            },
            "quantity": 1,
            "discountedTotal": "2000.00",
            "originalTotal": "2000.00",
            "skuId": "VWWDR233601370121",
            "variantTitle": "XS / White",
            "title": "Abiha|Cotton Gingham Dress with Pockets",
            "image": "https://cdn.shopify.com/s/files/1/0558/4909/1174/files/1_VWWDR2336013701_a4ed45bb-6889-424f-9bfd-f8466312f2cc.jpg?v=1701957236",
            "totalReceived": "3784.00",
            "lineItemId": "gid://shopify/LineItem/13712383803494",
            "productHandle": "gingham-glamour-mini-dress-with-pockets",
            "discountAllocation": "240.0",
            "order": {
                "totalPrice": "3784.00",
                "subtotalPrice": "3784.00",
                "totalShippingPrice": "0.00",
                "totalDiscounts": "516.00",
                "createdAt": "2024-01-17T11:38:59Z"
            },
            "isCancellable": true,
            "isReturnable": false
        },
        {
            "orderName": "#1113",
            "orderId": "gid://shopify/Order/5297336057958",
            "fullfillmentName": null,
            "displayStatus": "unfulfilled",
            "shippingAddress": {
                "address1": "Virgio (Ameyam Enterprise Private Limited) 168 19th Main Road Sector 4 HSR Layout",
                "address2": null,
                "city": "Bengaluru",
                "name": "Omesh Koul",
                "phone": null,
                "zip": "560102",
                "country": "India"
            },
            "quantity": 1,
            "discountedTotal": "2290.00",
            "originalTotal": "2290.00",
            "skuId": "VWWDR233601720123",
            "variantTitle": "M / Charcoal",
            "title": "Amrah|Flowy viscose dress with floral print",
            "image": "https://cdn.shopify.com/s/files/1/0558/4909/1174/files/1_VWWDR2336017201.jpg?v=1701958788",
            "totalReceived": "3784.00",
            "lineItemId": "gid://shopify/LineItem/13712383836262",
            "productHandle": "charcoal-fit-and-flare-dress-with-floral-print",
            "discountAllocation": "274.8",
            "order": {
                "totalPrice": "3784.00",
                "subtotalPrice": "3784.00",
                "totalShippingPrice": "0.00",
                "totalDiscounts": "516.00",
                "createdAt": "2024-01-17T11:38:59Z"
            },
            "isCancellable": true,
            "isReturnable": false
        },
        {
            "orderName": "#1112",
            "orderId": "gid://shopify/Order/5297290346598",
            "fullfillmentName": null,
            "displayStatus": "unfulfilled",
            "shippingAddress": {
                "address1": "Virgio (Ameyam Enterprise Private Limited) 168 19th Main Road Sector 4 HSR Layout",
                "address2": null,
                "city": "Bengaluru",
                "name": "Omesh Koul",
                "phone": null,
                "zip": "560102",
                "country": "India"
            },
            "quantity": 1,
            "discountedTotal": "10.00",
            "originalTotal": "10.00",
            "skuId": "VWWDR233601700123",
            "variantTitle": "M / Green",
            "title": "Aiza|Breezy cotton geo-print fit and flare dress",
            "image": "https://cdn.shopify.com/s/files/1/0558/4909/1174/files/1_VWWDR2336017001.jpg?v=1701959093",
            "totalReceived": "3910.50",
            "lineItemId": "gid://shopify/LineItem/13712230645862",
            "productHandle": "geo-printed-fit-and-flare-dress",
            "discountAllocation": "0.1",
            "order": {
                "totalPrice": "3910.50",
                "subtotalPrice": "3910.50",
                "totalShippingPrice": "0.00",
                "totalDiscounts": "39.50",
                "createdAt": "2024-01-17T10:11:43Z"
            },
            "isCancellable": true,
            "isReturnable": false
        },
        {
            "orderName": "#1112",
            "orderId": "gid://shopify/Order/5297290346598",
            "fullfillmentName": null,
            "displayStatus": "unfulfilled",
            "shippingAddress": {
                "address1": "Virgio (Ameyam Enterprise Private Limited) 168 19th Main Road Sector 4 HSR Layout",
                "address2": null,
                "city": "Bengaluru",
                "name": "Omesh Koul",
                "phone": null,
                "zip": "560102",
                "country": "India"
            },
            "quantity": 1,
            "discountedTotal": "2000.00",
            "originalTotal": "2000.00",
            "skuId": "VWWDR233601370121",
            "variantTitle": "XS / White",
            "title": "Abiha|Cotton Gingham Dress with Pockets",
            "image": "https://cdn.shopify.com/s/files/1/0558/4909/1174/files/1_VWWDR2336013701_a4ed45bb-6889-424f-9bfd-f8466312f2cc.jpg?v=1701957236",
            "totalReceived": "3910.50",
            "lineItemId": "gid://shopify/LineItem/13712230678630",
            "productHandle": "gingham-glamour-mini-dress-with-pockets",
            "discountAllocation": "20.0",
            "order": {
                "totalPrice": "3910.50",
                "subtotalPrice": "3910.50",
                "totalShippingPrice": "0.00",
                "totalDiscounts": "39.50",
                "createdAt": "2024-01-17T10:11:43Z"
            },
            "isCancellable": true,
            "isReturnable": false
        },
        {
            "orderName": "#1112",
            "orderId": "gid://shopify/Order/5297290346598",
            "fullfillmentName": null,
            "displayStatus": "unfulfilled",
            "shippingAddress": {
                "address1": "Virgio (Ameyam Enterprise Private Limited) 168 19th Main Road Sector 4 HSR Layout",
                "address2": null,
                "city": "Bengaluru",
                "name": "Omesh Koul",
                "phone": null,
                "zip": "560102",
                "country": "India"
            },
            "quantity": 1,
            "discountedTotal": "1940.00",
            "originalTotal": "1940.00",
            "skuId": "VWWDR233601630125",
            "variantTitle": "XL / White",
            "title": "Alfiya|Viscose Soft Floral Playsuit with Pockets",
            "image": "https://cdn.shopify.com/s/files/1/0558/4909/1174/files/1_VWWDR2336016301_401fb48c-0e81-45ca-81a5-0844d1fa4e87.jpg?v=1701956300",
            "totalReceived": "3910.50",
            "lineItemId": "gid://shopify/LineItem/13712230711398",
            "productHandle": "garden-whisper-sleeve-dress-with-pockets",
            "discountAllocation": "19.4",
            "order": {
                "totalPrice": "3910.50",
                "subtotalPrice": "3910.50",
                "totalShippingPrice": "0.00",
                "totalDiscounts": "39.50",
                "createdAt": "2024-01-17T10:11:43Z"
            },
            "isCancellable": true,
            "isReturnable": false
        }
    ],
    "customer": {
        "name": "omesh.koul@virgio.com",
        "phone": "+916005649119"
    }
}))

        {% comment %} const data = await response.json(); {% endcomment %}
        return data;
      } catch (error) {
        console.error('Error fetching data:', error);
        return null;
      }
    }

    async function renderData(isNext) {
      const dataContainer = document.getElementById('data-container');
      const loadMoreButton = document.getElementById('loadMoreButton');
      
      const loader = document.getElementById('loader');


           loader.style.display = 'block';


      const data = await fetchData();


      const splitData = {};

// Split the objects by orderName
data.orders.forEach(obj => {
    const orderName = obj["orderName"];
    if (!splitData[orderName]) {
        splitData[orderName] = [];
    }
    splitData[orderName].push(obj);
});
console.log("splitData",splitData)

      ordersGroup = splitData

      if (data) {
        // Update UI with the fetched data
        dataContainer.innerHTML += data.orders.map(order => {
          const {displayStatus} = order
           const {title} = order;

           const titles = title.split('|')
          
          return `
            <div class="order" onclick="redirectToOrderDetails('${order.orderName}','${order.lineItemId}')">

              <div class="order-title ${displayStatus === 'CANCELLED' ? 'order-title-cancel':''}">${useDeliveryStatusText(displayStatus)}</div>
              <div class="order-arriving">${useDeliveryText(order)}</div>

              <div style="display: flex;margin-top: 1.5rem;align-items: center;" >

                <div style="margin-right: 1.5rem;"><img  src="${order.image}" alt="${order.title}"  class="order-img"></div>
               
                <div>
              <div class="order-title1">${titles[0]}</div>
               <div class="order-title2">${titles[1]}</div>
              <div class="order-title3">Size: ${order.variantTitle}</div>
               <div class="order-title3">Qty: ${order.quantity}</div>
                </div>
              </div>

              </div>

            </div>
          `;
        }).join('');

        // Update pagination information
        endCursor = data.data.pageInfo.endCursor;
        const hasNextPage = data.data.pageInfo.hasNextPage;

        // Enable or disable the Load More button based on pagination status
        loadMoreButton.disabled = !hasNextPage;

        // Increment the pageCount for tracking
        pageCount = pageCount + 1;

        loader.style.display = 'none'; 
      }
    }

    function loadMoreData() {
      renderData();
    }

    // Initial render
    renderData();

    const useDeliveryStatusText = (displayStatus) => {
  if (displayStatus === 'unfulfilled') {
    return 'Order Confirmed';
  }
  if (displayStatus === 'CANCELLED') {
    return 'Order Cancelled';
  }
  //   }  // TODO handle cancelled reason logic
  if (displayStatus === 'FULFILLED' || displayStatus === 'READY_FOR_PICKUP') {
    return 'Ready to Ship';
  }
  if (displayStatus === 'IN_TRANSIT') {
    return 'Shipped';
  }
  if (displayStatus === 'OUT_FOR_DELIVERY') {
    return 'Out for Delivery';
  }
  if (displayStatus === 'DELIVERED') {
    return 'Delivered';
  }
  return '';
};

const useDeliveryText = (orderLineItem) => {
  console.log("orderLineItem",orderLineItem)
  if (orderLineItem.displayStatus === 'DELIVERED') {
    return `Delivered on ${orderLineItem.deliveredAt}`;
  }
  if (
    orderLineItem.displayStatus === 'CANCELLED' ||
    orderLineItem.estimatedDeliveryTime === '' ||
    orderLineItem.estimatedDeliveryTime === undefined ||
    orderLineItem.estimatedDeliveryTime === null
  ) {
    return '';
  }
  return `Arriving by ${orderLineItem?.estimatedDeliveryTime ?? ''}`;
};
</script>

{% include 'returnprime_script' %}
